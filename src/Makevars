SWIDIR=swipl-devel
SWISRC=$(SWIDIR)/src
SWICONF=linux

PKG_INCLUDES=-I$(SWICONF)/src -I$(SWISRC) -I$(SWISRC)/os -I$(SWISRC)/libtai -I$(SWISRC)/minizip -I/usr/share/R/include -I/usr/lib/R/site-library/Rcpp/include -I$(SWIDIR)/packages/cpp
PKG_CPPFLAGS=-O2 -gdwarf-2 -g3 -Wall -fno-strict-aliasing -fpic -D__SWI_PROLOG__ $(PKG_INCLUDES)
PKG_LIBS=-Wl,-Bsymbolic-functions -lgmp -lpthread

ROLOG=rolog.o RcppExports.o

SWIPL0=pl-wam.o pl-arith.o pl-bag.o pl-error.o pl-comp.o pl-zip.o pl-dwim.o\
  pl-ext.o pl-flag.o pl-funct.o pl-gc.o pl-privitf.o pl-list.o pl-string.o\
  pl-load.o pl-modul.o pl-op.o pl-prims.o pl-pro.o pl-proc.o pl-prof.o\
  pl-read.o pl-rec.o pl-setup.o pl-sys.o pl-trace.o pl-util.o pl-wic.o\
  pl-write.o pl-atom.o pl-term.o pl-thread.o pl-xterm.o pl-srcfile.o pl-beos.o\
  pl-attvar.o pl-gvar.o pl-btree.o pl-init.o pl-gmp.o pl-segstack.o pl-hash.o\
  pl-version.o pl-codetable.o pl-supervisor.o pl-dbref.o pl-termhash.o\
  pl-variant.o pl-assert.o pl-copyterm.o pl-debug.o pl-cont.o\
  pl-ressymbol.o pl-dict.o pl-trie.o pl-indirect.o pl-tabling.o pl-rsort.o\
  pl-mutex.o pl-allocpool.o pl-wrap.o pl-event.o pl-transaction.o pl-undo.o\
  pl-alloc.o pl-index.o pl-fli.o
SWIPL=$(addprefix $(SWISRC)/, $(SWIPL0))

OS0=pl-buffer.o pl-ctype.o pl-file.o pl-files.o pl-glob.o\
  pl-os.o pl-stream.o pl-string.o pl-table.o pl-text.o\
  pl-utf8.o pl-fmt.o pl-dtoa.o pl-option.o pl-cstack.o\
  pl-codelist.o pl-prologflag.o pl-tai.o pl-locale.o
OS=$(addprefix $(SWISRC)/os/, $(OS0))

LIBTAI0=caltime_utc.o caltime_tai.o leapsecs_sub.o\
  leapsecs_add.o caldate_fmjd.o caldate_mjd.o\
  leapsecs_init.o leapsecs_read.o tai_pack.o\
  tai_unpack.o
LIBTAI=$(addprefix $(SWISRC)/libtai/, $(LIBTAI0))

MINIZIP0=zip.o unzip.o ioapi.o
MINIZIP=$(addprefix $(SWISRC)/minizip/, $(MINIZIP0))

ROLOBJ=rolog.o RcppExports.o

SWIOBJ=$(SWIPL) $(OS) $(LIBTAI) $(MINIZIP)

OBJECTS=$(SWIOBJ) $(ROLOBJ)

$(SHLIB): lib

vmi:
	$(CC) $(PKG_CPPFLAGS) $(SWISRC)/mkvmi.c -o $(SWISRC)/mkvmi
	cd $(SWISRC) && ./mkvmi

defatom:
	$(CC) $(PKG_CPPFLAGS) $(SWISRC)/defatom.c -o $(SWISRC)/defatom
	cd $(SWISRC) && ./defatom

version:
	cd $(SWISRC) && ./mkversion.sh

swipl: $(SWIOBJ)
	$(CC) $(PKG_CPPFLAGS) -Dswipl_EXPORTS -c $(SWISRC)/pl-main.c -o $(SWISRC)/pl-main.o
	$(CC) -Wl,--export-dynamic -rdynamic -o $(SWISRC)/swipl $(SWISRC)/pl-main.o $(SWIOBJ) -lcurses -lform -lpthread -lgmp -lz -ldl -lrt -lm

%.o: %.c vmi defatom version
	$(CC) $(PKG_CPPFLAGS) -c $*.c -o $*.o

boot: swipl
	cd $(SWIDIR)/boot && ../src/swipl -q -O -o ../../../inst/home/boot.prc -b init.pl
	cp -R $(SWIDIR)/library ../inst/home
	$(SWISRC)/swipl -f none --no-packs -t halt --home=../inst/home -q -g "make_library_index('../inst/home/library')"

packages: sgml http process files

sgml:
	$(CC) $(PKG_CPPFLAGS) -Dplugin_sgml2pl_EXPORTS -I$(SWIDIR)/packages/sgml -o $(SWIDIR)/packages/sgml/sgml2pl.o -c $(SWIDIR)/packages/sgml/sgml2pl.c
	$(CC) $(PKG_CPPFLAGS) -Dplugin_sgml2pl_EXPORTS -I$(SWIDIR)/packages/sgml -o $(SWIDIR)/packages/sgml/util.o -c $(SWIDIR)/packages/sgml/util.c
	$(CC) $(PKG_CPPFLAGS) -Dplugin_sgml2pl_EXPORTS -I$(SWIDIR)/packages/sgml -o $(SWIDIR)/packages/sgml/quote.o -c $(SWIDIR)/packages/sgml/quote.c
	$(CC) $(PKG_CPPFLAGS) -Dplugin_sgml2pl_EXPORTS -I$(SWIDIR)/packages/sgml -o $(SWIDIR)/packages/sgml/xsd.o -c $(SWIDIR)/packages/sgml/xsd.c
	$(CC) $(PKG_CPPFLAGS) -Dplugin_sgml2pl_EXPORTS -I$(SWIDIR)/packages/sgml -o $(SWIDIR)/packages/sgml/catalog.o -c $(SWIDIR)/packages/sgml/catalog.c
	$(CC) -shared -Wl,--export-dynamic -rdynamic -o ../inst/home/lib/sgml2pl.so $(SWIDIR)/packages/sgml/*.o -lcurses -lform -lgmp -lz -ldl -lrt -lm -ledit -lpthread
	cp -R $(SWIDIR)/packages/sgml/*.pl ../inst/home/library

http:
	cp -R $(SWIDIR)/packages/http ../inst/home/library

process:
	$(CC) -I$(SWICONF)/packages/clib $(PKG_CPPFLAGS) -Dplugin_process_EXPORTS -I$(SWIDIR)/packages/clib -o $(SWIDIR)/packages/clib/process.o -c $(SWIDIR)/packages/clib/process.c
	$(CC) -shared -Wl,--export-dynamic -rdynamic -o ../inst/home/lib/process.so $(SWIDIR)/packages/clib/process.o -lcurses -lform -lgmp -lz -ldl -lrt -lm -ledit -lpthread
	cp -R $(SWIDIR)/packages/clib/process.pl ../inst/home/library

files:
	$(CC) -I$(SWICONF)/packages/clib $(PKG_CPPFLAGS) -Dplugin_files_EXPORTS -I$(SWIDIR)/packages/clib -o $(SWIDIR)/packages/clib/error.o -c $(SWIDIR)/packages/clib/error.c
	$(CC) -I$(SWICONF)/packages/clib $(PKG_CPPFLAGS) -Dplugin_files_EXPORTS -I$(SWIDIR)/packages/clib -o $(SWIDIR)/packages/clib/files.o -c $(SWIDIR)/packages/clib/files.c
	$(CC) -shared -Wl,--export-dynamic -rdynamic -o ../inst/home/lib/files.so $(SWIDIR)/packages/clib/error.o  $(SWIDIR)/packages/clib/files.o -lcurses -lform -lgmp -lz -ldl -lrt -lm -ledit -lpthread
	cp -R $(SWIDIR)/packages/clib/filesex.pl ../inst/home/library

lib: boot packages $(ROLOG)
